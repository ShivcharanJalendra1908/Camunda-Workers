<?xml version="1.0" encoding="UTF-8"?>
<bpmn:definitions xmlns:bpmn="http://www.omg.org/spec/BPMN/20100524/MODEL"
                   xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI"
                   xmlns:dc="http://www.omg.org/spec/DD/20100524/DC"
                   xmlns:di="http://www.omg.org/spec/DD/20100524/DI"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xmlns:zeebe="http://camunda.org/schema/zeebe/1.0"
                   id="Definitions_FranchiseDetail"
                   targetNamespace="http://bpmn.io/schema/bpmn">
  
  <!-- Error Definition -->
  <bpmn:error id="Error_FranchiseNotFound" name="Franchise Not Found" errorCode="FRANCHISE_NOT_FOUND" />
  
  <bpmn:process id="franchise-detail-workflow" name="Franchise Detail Page Workflow" isExecutable="true">
    
    <!-- Start Event -->
    <bpmn:startEvent id="StartDetailPage" name="Start Detail Page">
      <bpmn:outgoing>Flow_ToValidateSubscription</bpmn:outgoing>
    </bpmn:startEvent>
    
    <!-- Validate Subscription -->
    <bpmn:serviceTask id="ValidateSubscription" name="Validate Subscription">
      <bpmn:extensionElements>
        <zeebe:taskDefinition type="validate-subscription" />
      </bpmn:extensionElements>
      <bpmn:incoming>Flow_ToValidateSubscription</bpmn:incoming>
      <bpmn:outgoing>Flow_ToValidationGateway</bpmn:outgoing>
    </bpmn:serviceTask>
    
    <!-- Validation Gateway -->
    <bpmn:exclusiveGateway id="ValidationGateway" name="Subscription Valid?">
      <bpmn:incoming>Flow_ToValidationGateway</bpmn:incoming>
      <bpmn:outgoing>Flow_ToInvalidSubscription</bpmn:outgoing>
      <bpmn:outgoing>Flow_ToParallelFetch</bpmn:outgoing>
    </bpmn:exclusiveGateway>
    
    <!-- Invalid Subscription Error End -->
    <bpmn:endEvent id="InvalidSubscriptionEnd" name="Invalid Subscription">
      <bpmn:incoming>Flow_ToInvalidSubscription</bpmn:incoming>
      <bpmn:errorEventDefinition errorRef="Error_InvalidSubscription" />
    </bpmn:endEvent>
    
    <!-- Parallel Gateway - Split -->
    <bpmn:parallelGateway id="ParallelDataFetch" name="Parallel Data Fetch">
      <bpmn:incoming>Flow_ToParallelFetch</bpmn:incoming>
      <bpmn:outgoing>Flow_ToQueryFranchise</bpmn:outgoing>
      <bpmn:outgoing>Flow_ToQueryOutlets</bpmn:outgoing>
      <bpmn:outgoing>Flow_ToQueryVerification</bpmn:outgoing>
      <bpmn:outgoing>Flow_ToQueryRelated</bpmn:outgoing>
    </bpmn:parallelGateway>
    
    <!-- Query Franchise Details -->
    <bpmn:serviceTask id="QueryFranchiseDetails" name="Query Franchise Details">
      <bpmn:extensionElements>
        <zeebe:taskDefinition type="query-postgresql" />
        <zeebe:taskHeaders>
          <zeebe:header key="queryType" value="franchise_full_details" />
        </zeebe:taskHeaders>
      </bpmn:extensionElements>
      <bpmn:incoming>Flow_ToQueryFranchise</bpmn:incoming>
      <bpmn:outgoing>Flow_FranchiseToJoin</bpmn:outgoing>
    </bpmn:serviceTask>
    
    <!-- Query Outlets -->
    <bpmn:serviceTask id="QueryOutlets" name="Query Outlets">
      <bpmn:extensionElements>
        <zeebe:taskDefinition type="query-postgresql" />
        <zeebe:taskHeaders>
          <zeebe:header key="queryType" value="franchise_outlets" />
        </zeebe:taskHeaders>
      </bpmn:extensionElements>
      <bpmn:incoming>Flow_ToQueryOutlets</bpmn:incoming>
      <bpmn:outgoing>Flow_OutletsToJoin</bpmn:outgoing>
    </bpmn:serviceTask>
    
    <!-- Query Verification -->
    <bpmn:serviceTask id="QueryVerification" name="Query Verification">
      <bpmn:extensionElements>
        <zeebe:taskDefinition type="query-postgresql" />
        <zeebe:taskHeaders>
          <zeebe:header key="queryType" value="franchise_verification" />
        </zeebe:taskHeaders>
      </bpmn:extensionElements>
      <bpmn:incoming>Flow_ToQueryVerification</bpmn:incoming>
      <bpmn:outgoing>Flow_VerificationToJoin</bpmn:outgoing>
    </bpmn:serviceTask>
    
    <!-- Query Related Franchises -->
    <bpmn:serviceTask id="QueryRelatedFranchises" name="Query Related Franchises">
      <bpmn:extensionElements>
        <zeebe:taskDefinition type="query-elasticsearch" />
        <zeebe:taskHeaders>
          <zeebe:header key="queryType" value="similar_franchises" />
        </zeebe:taskHeaders>
      </bpmn:extensionElements>
      <bpmn:incoming>Flow_ToQueryRelated</bpmn:incoming>
      <bpmn:outgoing>Flow_RelatedToJoin</bpmn:outgoing>
    </bpmn:serviceTask>
    
    <!-- Parallel Gateway - Join -->
    <bpmn:parallelGateway id="JoinResults" name="Join Results">
      <bpmn:incoming>Flow_FranchiseToJoin</bpmn:incoming>
      <bpmn:incoming>Flow_OutletsToJoin</bpmn:incoming>
      <bpmn:incoming>Flow_VerificationToJoin</bpmn:incoming>
      <bpmn:incoming>Flow_RelatedToJoin</bpmn:incoming>
      <bpmn:outgoing>Flow_ToResultsGateway</bpmn:outgoing>
    </bpmn:parallelGateway>
    
    <!-- Results Gateway -->
    <bpmn:exclusiveGateway id="ResultsGateway" name="Franchise Found?">
      <bpmn:incoming>Flow_ToResultsGateway</bpmn:incoming>
      <bpmn:outgoing>Flow_ToFranchiseNotFound</bpmn:outgoing>
      <bpmn:outgoing>Flow_ToCalculateMatch</bpmn:outgoing>
    </bpmn:exclusiveGateway>
    
    <!-- Franchise Not Found Error End -->
    <bpmn:endEvent id="FranchiseNotFoundEnd" name="Franchise Not Found">
      <bpmn:incoming>Flow_ToFranchiseNotFound</bpmn:incoming>
      <bpmn:errorEventDefinition errorRef="Error_FranchiseNotFound" />
    </bpmn:endEvent>
    
    <!-- Calculate Match Score -->
    <bpmn:serviceTask id="CalculateMatchScore" name="Calculate Match Score">
      <bpmn:extensionElements>
        <zeebe:taskDefinition type="calculate-match-score" />
      </bpmn:extensionElements>
      <bpmn:incoming>Flow_ToCalculateMatch</bpmn:incoming>
      <bpmn:outgoing>Flow_ToSelectTemplate</bpmn:outgoing>
    </bpmn:serviceTask>
    
    <!-- Select Template -->
    <bpmn:serviceTask id="SelectTemplate" name="Select Template">
      <bpmn:extensionElements>
        <zeebe:taskDefinition type="select-template" />
      </bpmn:extensionElements>
      <bpmn:incoming>Flow_ToSelectTemplate</bpmn:incoming>
      <bpmn:outgoing>Flow_ToBuildResponse</bpmn:outgoing>
    </bpmn:serviceTask>
    
    <!-- Build Response -->
    <bpmn:serviceTask id="BuildResponse" name="Build Response">
      <bpmn:extensionElements>
        <zeebe:taskDefinition type="build-response" />
      </bpmn:extensionElements>
      <bpmn:incoming>Flow_ToBuildResponse</bpmn:incoming>
      <bpmn:outgoing>Flow_ToCallbackBFF</bpmn:outgoing>
    </bpmn:serviceTask>
    
    <!-- Callback to BFF -->
    <bpmn:serviceTask id="CallbackBFF" name="Callback to BFF">
      <bpmn:extensionElements>
        <zeebe:taskDefinition type="callback-to-bff" />
      </bpmn:extensionElements>
      <bpmn:incoming>Flow_ToCallbackBFF</bpmn:incoming>
      <bpmn:outgoing>Flow_ToComplete</bpmn:outgoing>
    </bpmn:serviceTask>
    
    <!-- End Event -->
    <bpmn:endEvent id="DetailPageComplete" name="Detail Page Complete">
      <bpmn:incoming>Flow_ToComplete</bpmn:incoming>
    </bpmn:endEvent>
    
    <!-- Sequence Flows -->
    <bpmn:sequenceFlow id="Flow_ToValidateSubscription" sourceRef="StartDetailPage" targetRef="ValidateSubscription" />
    <bpmn:sequenceFlow id="Flow_ToValidationGateway" sourceRef="ValidateSubscription" targetRef="ValidationGateway" />
    <bpmn:sequenceFlow id="Flow_ToInvalidSubscription" name="Invalid" sourceRef="ValidationGateway" targetRef="InvalidSubscriptionEnd">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">${isValid == false}</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="Flow_ToParallelFetch" name="Valid" sourceRef="ValidationGateway" targetRef="ParallelDataFetch">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">${isValid == true}</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="Flow_ToQueryFranchise" sourceRef="ParallelDataFetch" targetRef="QueryFranchiseDetails" />
    <bpmn:sequenceFlow id="Flow_ToQueryOutlets" sourceRef="ParallelDataFetch" targetRef="QueryOutlets" />
    <bpmn:sequenceFlow id="Flow_ToQueryVerification" sourceRef="ParallelDataFetch" targetRef="QueryVerification" />
    <bpmn:sequenceFlow id="Flow_ToQueryRelated" sourceRef="ParallelDataFetch" targetRef="QueryRelatedFranchises" />
    <bpmn:sequenceFlow id="Flow_FranchiseToJoin" sourceRef="QueryFranchiseDetails" targetRef="JoinResults" />
    <bpmn:sequenceFlow id="Flow_OutletsToJoin" sourceRef="QueryOutlets" targetRef="JoinResults" />
    <bpmn:sequenceFlow id="Flow_VerificationToJoin" sourceRef="QueryVerification" targetRef="JoinResults" />
    <bpmn:sequenceFlow id="Flow_RelatedToJoin" sourceRef="QueryRelatedFranchises" targetRef="JoinResults" />
    <bpmn:sequenceFlow id="Flow_ToResultsGateway" sourceRef="JoinResults" targetRef="ResultsGateway" />
    <bpmn:sequenceFlow id="Flow_ToFranchiseNotFound" name="Not Found" sourceRef="ResultsGateway" targetRef="FranchiseNotFoundEnd">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">${franchiseFound == false}</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="Flow_ToCalculateMatch" name="Found" sourceRef="ResultsGateway" targetRef="CalculateMatchScore">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">${franchiseFound == true}</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="Flow_ToSelectTemplate" sourceRef="CalculateMatchScore" targetRef="SelectTemplate" />
    <bpmn:sequenceFlow id="Flow_ToBuildResponse" sourceRef="SelectTemplate" targetRef="BuildResponse" />
    <bpmn:sequenceFlow id="Flow_ToCallbackBFF" sourceRef="BuildResponse" targetRef="CallbackBFF" />
    <bpmn:sequenceFlow id="Flow_ToComplete" sourceRef="CallbackBFF" targetRef="DetailPageComplete" />
    
  </bpmn:process>
  
  <!-- Additional Error Definition -->
  <bpmn:error id="Error_InvalidSubscription" name="Invalid Subscription" errorCode="INVALID_SUBSCRIPTION" />
  
  <!-- BPMN Diagram -->
  <bpmndi:BPMNDiagram id="BPMNDiagram_FranchiseDetail">
    <bpmndi:BPMNPlane id="BPMNPlane_FranchiseDetail" bpmnElement="franchise-detail-workflow">
      
      <!-- Start -->
      <bpmndi:BPMNShape id="Shape_StartDetailPage" bpmnElement="StartDetailPage">
        <dc:Bounds x="152" y="282" width="36" height="36" />
      </bpmndi:BPMNShape>
      
      <!-- Validate Subscription -->
      <bpmndi:BPMNShape id="Shape_ValidateSubscription" bpmnElement="ValidateSubscription">
        <dc:Bounds x="240" y="260" width="100" height="80" />
      </bpmndi:BPMNShape>
      
      <!-- Validation Gateway -->
      <bpmndi:BPMNShape id="Shape_ValidationGateway" bpmnElement="ValidationGateway">
        <dc:Bounds x="395" y="275" width="50" height="50" />
      </bpmndi:BPMNShape>
      
      <!-- Invalid Subscription End -->
      <bpmndi:BPMNShape id="Shape_InvalidSubscriptionEnd" bpmnElement="InvalidSubscriptionEnd">
        <dc:Bounds x="422" y="162" width="36" height="36" />
      </bpmndi:BPMNShape>
      
      <!-- Parallel Gateway Split -->
      <bpmndi:BPMNShape id="Shape_ParallelDataFetch" bpmnElement="ParallelDataFetch">
        <dc:Bounds x="500" y="275" width="50" height="50" />
      </bpmndi:BPMNShape>
      
      <!-- Query Franchise Details -->
      <bpmndi:BPMNShape id="Shape_QueryFranchiseDetails" bpmnElement="QueryFranchiseDetails">
        <dc:Bounds x="615" y="140" width="100" height="80" />
      </bpmndi:BPMNShape>
      
      <!-- Query Outlets -->
      <bpmndi:BPMNShape id="Shape_QueryOutlets" bpmnElement="QueryOutlets">
        <dc:Bounds x="615" y="240" width="100" height="80" />
      </bpmndi:BPMNShape>
      
      <!-- Query Verification -->
      <bpmndi:BPMNShape id="Shape_QueryVerification" bpmnElement="QueryVerification">
        <dc:Bounds x="615" y="340" width="100" height="80" />
      </bpmndi:BPMNShape>
      
      <!-- Query Related Franchises -->
      <bpmndi:BPMNShape id="Shape_QueryRelatedFranchises" bpmnElement="QueryRelatedFranchises">
        <dc:Bounds x="615" y="440" width="100" height="80" />
      </bpmndi:BPMNShape>
      
      <!-- Parallel Gateway Join -->
      <bpmndi:BPMNShape id="Shape_JoinResults" bpmnElement="JoinResults">
        <dc:Bounds x="780" y="275" width="50" height="50" />
      </bpmndi:BPMNShape>
      
      <!-- Results Gateway -->
      <bpmndi:BPMNShape id="Shape_ResultsGateway" bpmnElement="ResultsGateway">
        <dc:Bounds x="885" y="275" width="50" height="50" />
      </bpmndi:BPMNShape>
      
      <!-- Franchise Not Found End -->
      <bpmndi:BPMNShape id="Shape_FranchiseNotFoundEnd" bpmnElement="FranchiseNotFoundEnd">
        <dc:Bounds x="912" y="162" width="36" height="36" />
      </bpmndi:BPMNShape>
      
      <!-- Calculate Match Score -->
      <bpmndi:BPMNShape id="Shape_CalculateMatchScore" bpmnElement="CalculateMatchScore">
        <dc:Bounds x="990" y="260" width="100" height="80" />
      </bpmndi:BPMNShape>
      
      <!-- Select Template -->
      <bpmndi:BPMNShape id="Shape_SelectTemplate" bpmnElement="SelectTemplate">
        <dc:Bounds x="1150" y="260" width="100" height="80" />
      </bpmndi:BPMNShape>
      
      <!-- Build Response -->
      <bpmndi:BPMNShape id="Shape_BuildResponse" bpmnElement="BuildResponse">
        <dc:Bounds x="1310" y="260" width="100" height="80" />
      </bpmndi:BPMNShape>
      
      <!-- Callback to BFF -->
      <bpmndi:BPMNShape id="Shape_CallbackBFF" bpmnElement="CallbackBFF">
        <dc:Bounds x="1470" y="260" width="100" height="80" />
      </bpmndi:BPMNShape>
      
      <!-- Detail Page Complete -->
      <bpmndi:BPMNShape id="Shape_DetailPageComplete" bpmnElement="DetailPageComplete">
        <dc:Bounds x="1632" y="282" width="36" height="36" />
      </bpmndi:BPMNShape>
      
      <!-- Edges -->
      <bpmndi:BPMNEdge id="Edge_ToValidateSubscription" bpmnElement="Flow_ToValidateSubscription">
        <di:waypoint x="188" y="300" />
        <di:waypoint x="240" y="300" />
      </bpmndi:BPMNEdge>
      
      <bpmndi:BPMNEdge id="Edge_ToValidationGateway" bpmnElement="Flow_ToValidationGateway">
        <di:waypoint x="340" y="300" />
        <di:waypoint x="395" y="300" />
      </bpmndi:BPMNEdge>
      
      <bpmndi:BPMNEdge id="Edge_ToInvalidSubscription" bpmnElement="Flow_ToInvalidSubscription">
        <di:waypoint x="420" y="275" />
        <di:waypoint x="440" y="198" />
      </bpmndi:BPMNEdge>
      
      <bpmndi:BPMNEdge id="Edge_ToParallelFetch" bpmnElement="Flow_ToParallelFetch">
        <di:waypoint x="445" y="300" />
        <di:waypoint x="500" y="300" />
      </bpmndi:BPMNEdge>
      
      <bpmndi:BPMNEdge id="Edge_ToQueryFranchise" bpmnElement="Flow_ToQueryFranchise">
        <di:waypoint x="525" y="275" />
        <di:waypoint x="525" y="180" />
        <di:waypoint x="615" y="180" />
      </bpmndi:BPMNEdge>
      
      <bpmndi:BPMNEdge id="Edge_ToQueryOutlets" bpmnElement="Flow_ToQueryOutlets">
        <di:waypoint x="550" y="280" />
        <di:waypoint x="615" y="280" />
      </bpmndi:BPMNEdge>
      
      <bpmndi:BPMNEdge id="Edge_ToQueryVerification" bpmnElement="Flow_ToQueryVerification">
        <di:waypoint x="525" y="325" />
        <di:waypoint x="525" y="380" />
        <di:waypoint x="615" y="380" />
      </bpmndi:BPMNEdge>
      
      <bpmndi:BPMNEdge id="Edge_ToQueryRelated" bpmnElement="Flow_ToQueryRelated">
        <di:waypoint x="525" y="325" />
        <di:waypoint x="525" y="480" />
        <di:waypoint x="615" y="480" />
      </bpmndi:BPMNEdge>
      
      <bpmndi:BPMNEdge id="Edge_FranchiseToJoin" bpmnElement="Flow_FranchiseToJoin">
        <di:waypoint x="715" y="180" />
        <di:waypoint x="805" y="180" />
        <di:waypoint x="805" y="275" />
      </bpmndi:BPMNEdge>
      
      <bpmndi:BPMNEdge id="Edge_OutletsToJoin" bpmnElement="Flow_OutletsToJoin">
        <di:waypoint x="715" y="280" />
        <di:waypoint x="780" y="300" />
      </bpmndi:BPMNEdge>
      
      <bpmndi:BPMNEdge id="Edge_VerificationToJoin" bpmnElement="Flow_VerificationToJoin">
        <di:waypoint x="715" y="380" />
        <di:waypoint x="805" y="380" />
        <di:waypoint x="805" y="325" />
      </bpmndi:BPMNEdge>
      
      <bpmndi:BPMNEdge id="Edge_RelatedToJoin" bpmnElement="Flow_RelatedToJoin">
        <di:waypoint x="715" y="480" />
        <di:waypoint x="805" y="480" />
        <di:waypoint x="805" y="325" />
      </bpmndi:BPMNEdge>
      
      <bpmndi:BPMNEdge id="Edge_ToResultsGateway" bpmnElement="Flow_ToResultsGateway">
        <di:waypoint x="830" y="300" />
        <di:waypoint x="885" y="300" />
      </bpmndi:BPMNEdge>
      
      <bpmndi:BPMNEdge id="Edge_ToFranchiseNotFound" bpmnElement="Flow_ToFranchiseNotFound">
        <di:waypoint x="910" y="275" />
        <di:waypoint x="930" y="198" />
      </bpmndi:BPMNEdge>
      
      <bpmndi:BPMNEdge id="Edge_ToCalculateMatch" bpmnElement="Flow_ToCalculateMatch">
        <di:waypoint x="935" y="300" />
        <di:waypoint x="990" y="300" />
      </bpmndi:BPMNEdge>
      
      <bpmndi:BPMNEdge id="Edge_ToSelectTemplate" bpmnElement="Flow_ToSelectTemplate">
        <di:waypoint x="1090" y="300" />
        <di:waypoint x="1150" y="300" />
      </bpmndi:BPMNEdge>
      
      <bpmndi:BPMNEdge id="Edge_ToBuildResponse" bpmnElement="Flow_ToBuildResponse">
        <di:waypoint x="1250" y="300" />
        <di:waypoint x="1310" y="300" />
      </bpmndi:BPMNEdge>
      
      <bpmndi:BPMNEdge id="Edge_ToCallbackBFF" bpmnElement="Flow_ToCallbackBFF">
        <di:waypoint x="1410" y="300" />
        <di:waypoint x="1470" y="300" />
      </bpmndi:BPMNEdge>
      
      <bpmndi:BPMNEdge id="Edge_ToComplete" bpmnElement="Flow_ToComplete">
        <di:waypoint x="1570" y="300" />
        <di:waypoint x="1632" y="300" />
      </bpmndi:BPMNEdge>
      
    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>
  
</bpmn:definitions>